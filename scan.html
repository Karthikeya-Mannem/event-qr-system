<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scan Team QR</title>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- QR Scanner -->
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    #reader {
      width: 320px;
      margin-top: 20px;
    }
    #result {
      margin-top: 20px;
      white-space: pre-line;
      font-size: 16px;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h2>Scan Team QR</h2>

<div id="reader"></div>
<div id="result"></div>

<script>
/************ SUPABASE CONFIG ************/
const supabaseUrl = "https://oizydyfwoymfaspnylno.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9penlkeWZ3b3ltZmFzcG55bG5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MjEwMTAsImV4cCI6MjA4NjE5NzAxMH0.mupSJXh50rr715sVGX0MpKe-5aLB5EK70i_w4p_mDII";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

/************ GLOBAL STATE ************/
const resultDiv = document.getElementById("result");
const readerDiv = document.getElementById("reader");

let scanLocked = false;
let scannerRunning = false;

const html5QrCode = new Html5Qrcode("reader");

/************ AUTO DAY DETECTION ************/
async function getCurrentDay() {
  const { data, error } = await supabase
    .from("event_config")
    .select("event_start_date")
    .single();

  if (error || !data) return null;

  const startDate = new Date(data.event_start_date);
  const today = new Date();

  startDate.setHours(0,0,0,0);
  today.setHours(0,0,0,0);

  const diffDays =
    Math.floor((today - startDate) / (1000 * 60 * 60 * 24)) + 1;

  return diffDays; // Day-1, Day-2, Day-3
}

/************ GET ACTIVE SESSION ************/
async function getActiveSession(day) {
  const now = new Date();
  const currentTime = now.toTimeString().slice(0, 8);

  const { data, error } = await supabase
    .from("time_windows")
    .select("*")
    .eq("day", day)
    .eq("is_active", true);

  if (error || !data) return null;

  for (let session of data) {
    if (
      currentTime >= session.start_time &&
      currentTime <= session.end_time
    ) {
      return session;
    }
  }
  return null;
}

/************ QR SUCCESS HANDLER ************/
async function onScanSuccess(decodedText) {
  if (scanLocked) return;
  scanLocked = true;

  const teamId = decodedText.trim();

  if (scannerRunning) {
    await html5QrCode.stop();
    scannerRunning = false;
  }
  readerDiv.style.display = "none";

  const day = await getCurrentDay();
  if (!day) {
    resultDiv.innerText = "‚ùå Event config missing";
    return;
  }

  /* ‚è∞ ACTIVE SESSION */
  const session = await getActiveSession(day);
  if (!session) {
    resultDiv.innerText = "‚è∞ Snack time is CLOSED";

    setTimeout(() => {
      scanLocked = false;
      readerDiv.style.display = "block";
      startScanner();
    }, 3000);

    return;
  }

  try {
    /* üîç FETCH TEAM */
    const { data: team, error } = await supabase
      .from("teams")
      .select("*")
      .eq("team_id", teamId)
      .single();

    if (error || !team) {
      resultDiv.innerText = "‚ùå Invalid QR Code";
      return;
    }

    if (team.status === "ELIMINATED") {
      resultDiv.innerText = "‚ùå Team Eliminated";
      return;
    }

    /* üîÅ SESSION DUPLICATE CHECK */
    const { data: alreadyScanned } = await supabase
      .from("team_session_scans")
      .select("*")
      .eq("team_id", teamId)
      .eq("session_id", session.id)
      .single();

    if (alreadyScanned) {
      resultDiv.innerText =
        "‚ùå Already scanned in this session\n\n" +
        session.session_name;

      setTimeout(() => location.reload(), 4000);
      return;
    }

    /* üç™ DAILY LIMIT (example: Day-1 = 2) */
    if (day === 1 && team.day1_count >= 2) {
      resultDiv.innerText = "‚ùå Day 1 snack limit reached";
      return;
    }

    /* ‚úÖ UPDATE COUNT */
    await supabase
      .from("teams")
      .update({ day1_count: team.day1_count + 1 })
      .eq("team_id", teamId);

    /* ‚úÖ RECORD SESSION SCAN */
    await supabase
      .from("team_session_scans")
      .insert({
        team_id: teamId,
        session_id: session.id
      });

    /* ‚úÖ ACKNOWLEDGEMENT */
    resultDiv.innerText =
      "‚úÖ Snack Issued Successfully\n\n" +
      "Team: " + team.team_name + "\n" +
      "Day: " + day + "\n" +
      "Session: " + session.session_name;

    setTimeout(() => location.reload(), 5000);

  } catch (err) {
    console.error(err);
    resultDiv.innerText = "‚ùå Unexpected error";
  }
}

/************ START SCANNER ************/
function startScanner() {
  if (scannerRunning) return;

  scannerRunning = true;
  html5QrCode.start(
    { facingMode: "environment" },   // BACK CAMERA
    { fps: 10, qrbox: 250 },
    onScanSuccess
  ).catch(err => {
    scannerRunning = false;
    console.error(err);
    resultDiv.innerText = "‚ùå Camera access failed";
  });
}

startScanner();
</script>

</body>
</html>
