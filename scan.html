<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Scan Team QR</title>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 10px;
    }
    #reader {
      width: 320px;
      margin-top: 20px;
      display: none;
    }
    #result {
      margin-top: 20px;
      white-space: pre-line;
      font-size: 16px;
      font-weight: bold;
    }
    #startBtn {
      padding: 12px 20px;
      font-size: 16px;
    }
  </style>
</head>
<body>

<h2>Scan Team QR</h2>

<button id="startBtn">▶ Start Scanner</button>
<div id="reader"></div>
<div id="result"></div>

<script>
/************ SUPABASE CONFIG ************/
const supabaseUrl = "https://oizydyfwoymfaspnylno.supabase.co";
const supabaseKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9penlkeWZ3b3ltZmFzcG55bG5vIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA2MjEwMTAsImV4cCI6MjA4NjE5NzAxMH0.mupSJXh50rr715sVGX0MpKe-5aLB5EK70i_w4p_mDII";
const supabase = supabase.createClient(supabaseUrl, supabaseKey);

/************ STATE ************/
const resultDiv = document.getElementById("result");
const readerDiv = document.getElementById("reader");
const startBtn = document.getElementById("startBtn");

let scanLocked = false;
let scannerRunning = false;

const html5QrCode = new Html5Qrcode("reader");

/************ AUTO DAY ************/
async function getCurrentDay() {
  const { data } = await supabase
    .from("event_config")
    .select("event_start_date")
    .single();

  const start = new Date(data.event_start_date);
  const today = new Date();
  start.setHours(0,0,0,0);
  today.setHours(0,0,0,0);

  return Math.floor((today - start)/(86400000)) + 1;
}

/************ ACTIVE SESSION ************/
async function getActiveSession(day) {
  const time = new Date().toTimeString().slice(0,8);

  const { data } = await supabase
    .from("time_windows")
    .select("*")
    .eq("day", day)
    .eq("is_active", true);

  if (!data) return null;

  return data.find(s =>
    time >= s.start_time && time <= s.end_time
  );
}

/************ SCAN SUCCESS ************/
async function onScanSuccess(text) {
  if (scanLocked) return;
  scanLocked = true;

  const teamId = text.trim();

  await html5QrCode.stop();
  scannerRunning = false;
  readerDiv.style.display = "none";

  const day = await getCurrentDay();
  const session = await getActiveSession(day);

  if (!session) {
    resultDiv.innerText = "⏰ Snack time CLOSED";
    resetScanner();
    return;
  }

  const { data: team } = await supabase
    .from("teams")
    .select("*")
    .eq("team_id", teamId)
    .single();

  if (!team) {
    resultDiv.innerText = "❌ Invalid QR";
    resetScanner();
    return;
  }

  const { data: already } = await supabase
    .from("team_session_scans")
    .select("*")
    .eq("team_id", teamId)
    .eq("session_id", session.id)
    .single();

  if (already) {
    resultDiv.innerText = "❌ Already scanned this session";
    resetScanner();
    return;
  }

  await supabase
    .from("teams")
    .update({ day1_count: team.day1_count + 1 })
    .eq("team_id", teamId);

  await supabase
    .from("team_session_scans")
    .insert({ team_id: teamId, session_id: session.id });

  resultDiv.innerText =
    "✅ Snack Issued\n" +
    "Team: " + team.team_name + "\n" +
    "Session: " + session.session_name;

  setTimeout(() => location.reload(), 5000);
}

/************ START / RESET ************/
function startScanner() {
  if (scannerRunning) return;
  scannerRunning = true;
  readerDiv.style.display = "block";

  html5QrCode.start(
    { facingMode: "environment" },
    { fps: 10, qrbox: 250 },
    onScanSuccess
  );
}

function resetScanner() {
  setTimeout(() => {
    scanLocked = false;
    startBtn.style.display = "block";
    resultDiv.innerText = "";
  }, 3000);
}

/************ USER ACTION ************/
startBtn.onclick = () => {
  startBtn.style.display = "none";
  startScanner();
};
</script>

</body>
</html>
